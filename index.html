<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏•‡∏≤</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* ... CSS styles remain the same ... */
    </style>
</head>
<body>
    <div class="app-container" id="app">
        </div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxFoXmwC1r-T1D_X8posl-oWxivnu-MDVI50P6M1GXgHMhlaZktM_kKoQEYeIWuILM/exec";
    let session = { token: null, user: null };

    // ... (apiCall, renderLoginView, handleLogin, renderLeaveFormView, handleLeaveSubmit, loadLeaveBalance, renderCalendarView, buildCalendar, renderHistoryView, loadLeaveHistory, logout remain the same) ...
    // Paste all the functions from the previous index.html version here...
    
    // --- UPDATED Dashboard View ---
    function renderDashboardView() {
        const app = document.getElementById('app');
        const title = session.user.isHR ? "üëë ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î HR (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)" : "üëë ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ß‡∏±‡∏ô‡∏•‡∏≤";
        app.innerHTML = `
            <div class="view-container">
                 <div class="d-flex justify-content-between align-items-center">
                    <h2>${title}</h2>
                    <div>
                        ${(session.user.isManager || session.user.isHR) ? '<button class="btn btn-secondary btn-sm mr-2" onclick="handleDownloadReport(\'monthly\')">‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</button>' : ''}
                        ${(session.user.isManager || session.user.isHR) ? '<button class="btn btn-secondary btn-sm mr-2" onclick="handleDownloadReport(\'yearly\')">‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (‡∏õ‡∏µ)</button>' : ''}
                        ${(session.user.isManager || session.user.isHR) ? '<button class="btn btn-info btn-sm mr-2" onclick="renderCalendarView()">‡∏î‡∏π‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô</button>' : ''}
                        <button onclick="logout()" class="btn btn-sm btn-outline-danger">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
                    </div>
                 </div>
                 <p>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô: <strong>${session.user.name}</strong></p>
                 <div id="dashboardMessage" class="mt-3"></div>
                 <div class="table-responsive">
                    <table class="table table-bordered table-striped">
                        <thead class="thead-dark"><tr><th>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th><th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th>‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏≤</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                        <tbody id="dashboard-body"><tr><td colspan="6" class="text-center">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr></tbody>
                    </table>
                 </div>
                 <div class="nav-links"><a href="#" onclick="renderLeaveFormView()">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏¢‡∏∑‡πà‡∏ô‡∏•‡∏≤</a></div>
            </div>
        `;
        loadDashboardData();
    }

    // --- NEW FUNCTION for downloading report ---
    async function handleDownloadReport(period) {
        const buttonText = period === 'monthly' ? '‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)' : '‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (‡∏õ‡∏µ)';
        const button = event.target; 
        button.disabled = true;
        button.innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á...';
        try {
            const csvContent = await apiCall('getLeaveReportCsv', { period });
            
            // Create a Blob with UTF-8 BOM for Excel compatibility with Thai characters
            const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
            const blob = new Blob([bom, csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const fileName = period === 'yearly' 
                ? `leave_report_${year}.csv` 
                : `leave_report_${year}_${month}.csv`;

            link.setAttribute("href", url);
            link.setAttribute("download", fileName);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url); // Clean up

        } catch (error) {
            alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ: ' + error.message);
        } finally {
             button.disabled = false;
             button.innerText = buttonText;
        }
    }

    // --- UPDATED loadDashboardData ---
    async function loadDashboardData() {
        try {
            const requests = await apiCall('getDashboardData');
            const tbody = document.getElementById('dashboard-body');
            tbody.innerHTML = '';
            if (requests.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏≤</td></tr>';
                return;
            }
            requests.sort((a, b) => { // Keep the sorting logic
                const statusOrder = {"Pending": 1, "Manager Approved": 2, "Approved": 3, "Rejected": 4};
                const aStatus = statusOrder[a.Status] || 5;
                const bStatus = statusOrder[b.Status] || 5;
                if (aStatus < bStatus) return -1;
                if (aStatus > bStatus) return 1;
                return new Date(b.originalTimestamp) - new Date(a.originalTimestamp);
            });
            requests.forEach(req => {
                const status = req.Status || 'N/A';
                let actionButtons = '';
                const isManagerActionable = !session.user.isHR && status === 'Pending';
                const isHRActionable = session.user.isHR && (status === 'Pending' || status === 'Manager Approved');
                if (isManagerActionable || isHRActionable) {
                    actionButtons = `<button class="btn btn-sm btn-success" onclick="handleApproval(this, '${req.RequestID}', 'approve')">Approve</button> <button class="btn btn-sm btn-danger" onclick="handleApproval(this, '${req.RequestID}', 'reject')">Reject</button>`;
                }
                const row = document.createElement('tr');
                row.className = `status-${status.replace(/\s+/g, '-').toLowerCase()}`;
                let statusBadge = 'warning';
                if (status === 'Approved') statusBadge = 'success';
                if (status === 'Rejected') statusBadge = 'danger';
                if (status === 'Manager Approved') statusBadge = 'primary';
                let periodText = "";
                if (req.LeavePeriod === 'half_day_morning') periodText = " (‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡πÄ‡∏ä‡πâ‡∏≤)";
                if (req.LeavePeriod === 'half_day_afternoon') periodText = " (‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ö‡πà‡∏≤‡∏¢)";
                let dateDisplay = req.StartDate;
                if ((!req.LeavePeriod || req.LeavePeriod === 'full_day') && req.StartDate !== req.EndDate) {
                    dateDisplay = `${req.StartDate} - ${req.EndDate}`;
                }
                row.innerHTML = `<td>${req.EmployeeName || 'N/A'}</td><td>${req.LeaveType || 'N/A'}${periodText}</td><td>${dateDisplay}</td><td>${req.TotalDays || 'N/A'}</td><td class="status-cell"><span class="badge badge-${statusBadge}">${status}</span></td><td class="action-cell">${actionButtons}</td>`;
                tbody.appendChild(row);
            });
        } catch (error) { alert('Could not load dashboard data: ' + error.message); }
    }

    // --- UPDATED handleApproval with Optimistic UI ---
    async function handleApproval(buttonElement, requestId, approvalAction) {
        const row = buttonElement.closest('tr');
        const statusCell = row.querySelector('.status-cell');
        const actionCell = row.querySelector('.action-cell');
        
        // Optimistic UI Update
        actionCell.innerHTML = "Processing...";
        const newStatus = approvalAction === 'approve' ? (session.user.isHR ? 'Approved' : 'Manager Approved') : 'Rejected';
        const newStatusBadge = approvalAction === 'approve' ? (session.user.isHR ? 'success' : 'primary') : 'danger';
        const newRowClass = `status-${newStatus.replace(/\s+/g, '-').toLowerCase()}`;
        
        statusCell.innerHTML = `<span class="badge badge-${newStatusBadge}">${newStatus}</span>`;
        row.className = newRowClass;
        
        // Remove buttons immediately if final status
        if (newStatus === 'Approved' || newStatus === 'Rejected') {
             actionCell.innerHTML = "";
        }

        // Send request to backend
        try {
            const result = await apiCall('processApproval', { requestId, approvalAction });
            const msgDiv = document.getElementById('dashboardMessage');
            msgDiv.innerHTML = `<div class="alert alert-success">${result.message}</div>`;
            setTimeout(() => { msgDiv.innerHTML = '' }, 4000);
            
             // No need to reload data if successful, UI already updated
             // Except if manager approved, HR might need to see it, reload for HR view.
             if(newStatus === 'Manager Approved' && session.user.isHR) {
                 loadDashboardData(); 
             } else if (newStatus === 'Approved' || newStatus === 'Rejected') {
                 actionCell.innerHTML = ""; // Ensure buttons are gone
             }


        } catch(error) {
            alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message);
            // If it fails, reload the dashboard to get the correct state
            loadDashboardData(); 
        } 
    }

    // ... (loadLeaveHistory, loadLeaveBalance, logout, DOMContentLoaded remain the same) ...
    // Paste the rest of your functions here from the previous complete version
    async function loadLeaveHistory() { /* ... */ }
    async function loadLeaveBalance() { /* ... */ }
    function logout() { /* ... */ }
    document.addEventListener('DOMContentLoaded', () => { renderLoginView(); });

</script>
</body>
</html>
